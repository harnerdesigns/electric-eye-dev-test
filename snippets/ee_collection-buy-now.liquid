{% comment %} 
Generates a Buy Now Button or Add To Cart Button or nothing,
depending on the settings set in Theme Settings > Collections 
Accepts: -
product: {Object} Product Liquid object (optional) 
Usage: 
{% include
'ee_collection-buy-now', product: product %} 
{% endcomment %} 

{%- if product -%}
    {%- assign variantID = product.variants[0].id -%} 
{%- endif -%} 

{%- if settings.enable_ee_buy_now == true and settings.enable_ee_add_to_cart != true -%} 
    {%- assign BuyNow = true -%} 
{%- elsif settings.enable_ee_buy_now == true and settings.enable_ee_add_to_cart == true -%}
    {%- assign BuyNow = false -%} 
{%- endif -%}


{%- if product.available -%}
<button
  type="button"
  class="btn ee-atc-btn"
  data-variant_id="{{ variantID }}"
  data-redirect={{BuyNow}}
  data-add-to-cart
>
<span data-add-to-cart-text>

    {%- if BuyNow == true -%} 
    Buy Now 
    {%- else -%}
    Add To Cart
    {%- endif -%}
</span>
<span data-loader class="hide">{%- render 'icon-spinner' -%}</span>
</button>
<div class="product-form__error-message-wrapper product-form__error-message-wrapper--hidden" data-error-message-wrapper role="alert">
    <span class="visually-hidden">Error </span>
    {%- render 'icon-error' -%}
    <span class="product-form__error-message" data-error-message></span>
  </div>


{%- endif -%}


<script>
  window.onload = function() {
    let ee_buttons = document.getElementsByClassName("ee-atc-btn");

    for (let i = 0; i < ee_buttons.length; i++) {
      ee_buttons[i].onclick = function(e) {
        e.preventDefault();
        var variantID = this.dataset.variant_id;
        var clicked = this;
        
        if (clicked.dataset.redirect === 'true'){
            // Buy Now Should Only Checkout with selected product, regardless of what was already in cart.
            clearCart().then(()=>{ buyNow(clicked, variantID)} );
        } else {
            buyNow(clicked, variantID);
        }
      };
    }

  };

  function buyNow(clicked, variantID) {
    var parentDiv = clicked.closest('div');
    var themeProduct = new window.theme.Product(parentDiv);

    toggleLoading(clicked, true);

    fetch("/cart/add.js", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({items: [{  id: variantID, quantity: 1, form_type: 'product'  }] }),
    }).then(function(data) {
        toggleLoading(clicked, false);

        var response = data.json().then(function(response) {
            if (data.status === 200) {
                console.log(response);
                themeProduct._setupCartPopup(response.items[0]);
            if(clicked.dataset.redirect === 'true'){
                window.location = "/checkout";
                }
            } else {
            parentDiv.querySelector("div[data-error-message-wrapper]").style.display = "block";
            parentDiv.querySelector("span[data-error-message]").innerHTML = response.description;
            }
        });
    });
}


  function toggleLoading(clicked, disable){

    if(disable){
        clicked.querySelector("[data-add-to-cart-text]").classList.add("hide");
        clicked.querySelector("[data-loader]").classList.remove("hide");
        clicked.setAttribute("disabled", true);
    } else {
        clicked.querySelector("[data-add-to-cart-text]").classList.remove("hide");
        clicked.querySelector("[data-loader]").classList.add("hide");
        clicked.removeAttribute("disabled");
    }

  }

  function clearCart(cb){

    return fetch("/cart/clear.js", 
    {
        method: "POST",
        dataType: "text",
    }
);

}
</script>

<style>
  .ee-atc-btn {
    display: block;
    position: relative;
    z-index: 3;
    width: 100%;
    margin-bottom: 1rem;
  }
</style>
